<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contracts Table</title>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <link rel="stylesheet" href="https://use.typekit.net/nky4zkf.css">

  <style>
    @font-face {
      font-family: 'PublicoHeadline';
      src: url('https://www.cbsnews.com/fly/bundles/cbsnewscontent/fonts/PublicoHeadline-Black/PublicoHeadline-Black.woff2') format('woff2');
      font-weight: bold;
      font-style: normal;
    }

    body {
      font-family: "proxima-nova", sans-serif;
      margin: 0;
      padding: 1em;
      box-sizing: border-box;
    }

    h2 {
      font-family: "PublicoHeadline", serif;
      font-size: 1.5em;
      margin-bottom: 0.5em;
    }

  .table-scroll-container {
    overflow-x: auto;
    -webkit-overflow-scrolling:touch;
    width: 100%;
  }

    button {
      font-family: "proxima-nova", sans-serif;
      font-size: 0.8rem;
    }

    .tooltip-box {
      position: absolute;
      background: #333;
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      max-width: 300px;
      z-index: 1000;
      font-size: 0.9em;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      white-space: normal;
    }

  table.dataTable {
    width: 100% !important;
    border-collapse: collapse;
  }

  td.limited-column {
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

    #contracts-table_wrapper {
      width: 100%;
      overflow-x: auto;
    }

   #last-updated {
    font-size: 0.9em;
    color: #555;
    margin-bottom: 1em;
  }
  </style>
</head>
<body>

<h2>Contracts DOGE says it has canceled</h2>
<p id="last-updated"></p>

<div class="table-scroll-container">
  <table id="contracts-table" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th>PIID</th>
        <th>Agency</th>
        <th>Recipient</th>
        <th>Description</th>
        <th>FPDS Link</th>
        <th>Value</th>
        <th>Savings</th>
        <th>Date Canceled</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://pym.nprapps.org/pym.v1.min.js"></script>

<script>
  const today = new Date();
  const today_str = `${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}${today.getFullYear()}`;
  const csvUrl = `https://raw.githubusercontent.com/cbs-news-data/doge-data-public/main/data-outputs/contracts_doge_${today_str}.csv`;

  function formatMoney(val) {
    const num = parseFloat(val);
    return isNaN(num) ? "" : "$" + num.toLocaleString("en-US");
  }

  function updateTimestamp() {
    const nowEt = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
    document.getElementById("last-updated").textContent =
      "Last updated: " + nowEt.toLocaleString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      }) + " ET";
  }

  function initializePym() {
    if (window.pymChild) {
      window.pymChild.sendHeight();
    } else {
      window.pymChild = new pym.Child({ polling: 500 });
    }
  }

  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data.filter(row => Object.values(row).some(cell => cell));
      const tbody = $('#contracts-table tbody');
      data.forEach(row => {
        tbody.append(`
          <tr>
            <td>${row.piid}</td>
            <td>${row.agency.toUpperCase()}</td>
            <td>${row.vendor.toUpperCase()}</td>
            <td>${row.description}</td>
            <td><a href="${row.fpds_link}" target="_blank">View</a></td>
            <td>${formatMoney(row.value)}</td>
            <td>${formatMoney(row.savings)}</td>
            <td>${row.deleted_date}</td>
            <td>${row.fpds_status}</td>
          </tr>
        `);
      });

      $('#contracts-table').DataTable({
        responsive: true,
        scrollX: true,
        autoWidth: false,
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        dom: 'Bfrtip',
        buttons: [
          {
            extend: 'csv',
            text: 'Download the data',
            className: 'btn btn-primary'
          }
        ]
      });

      updateTimestamp();
      initializePym();
    }
  });

  // Tooltip logic (for truncated text)
  $(document).on('mouseenter', 'td.limited-column, td.description-column', function (e) {
    const $cell = $(this);
    if (this.offsetWidth < this.scrollWidth) {
      const tooltip = $('<div class="tooltip-box"></div>').text($cell.text());
      $('body').append(tooltip);
      tooltip.css({ top: e.pageY + 10, left: e.pageX + 10, opacity: 1 });
      $cell.data('tooltip', tooltip);
    }
  });

  $(document).on('mousemove', 'td.limited-column, td.description-column', function (e) {
    const tooltip = $(this).data('tooltip');
    if (tooltip) tooltip.css({ top: e.pageY + 10, left: e.pageX + 10 });
  });

  $(document).on('mouseleave', 'td.limited-column, td.description-column', function () {
    const tooltip = $(this).data('tooltip');
    if (tooltip) {
      tooltip.remove();
      $(this).removeData('tooltip');
    }
  });
</script>

</body>
</html>